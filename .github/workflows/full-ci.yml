name: Full CI Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, master, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install black==23.3.0 flake8==6.0.0 isort==5.12.0 mypy==1.3.0 pytest==7.4.0 pytest-cov==4.1.0
        pip install pytest

    - name: Black Code Formatter
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        black --check forest.py test_*.py
        
    - name: Import Sorting (isort)
      run: |
        echo "æ£€æŸ¥å¯¼å…¥é¡ºåº..."
        isort --check-only forest.py test_*.py
        
    - name: Lint with Flake8
      run: |
        echo "è¿è¡Œä»£ç æ£€æŸ¥..."
        flake8 forest.py test_*.py --count --max-complexity=15 --max-line-length=100
        
    - name: Type Checking
      run: |
        echo "è¿è¡Œç±»å‹æ£€æŸ¥..."
        mypy --ignore-missing-imports --disallow-untyped-defs forest.py || echo "ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Š"
        
  unit-tests:
    name: Unit Tests
    needs: code-quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Run unit tests
      run: |
        python -m pytest test_forest.py -v --tb=short --junitxml=junit/test-results-${{ matrix.python-version }}.xml
        
    - name: Run specific rule tests
      run: |
        python -m pytest test_rules.py -v --junitxml=junit/rule-results-${{ matrix.python-version }}.xml
        
    - name: Test coverage
      run: |
        python -m pytest --cov=forest --cov-report=xml --cov-report=html test_forest.py
        python -m pytest --cov=forest --cov-fail-under=70 || echo "è¦†ç›–ç‡ä½äº70%"
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: junit/*.xml
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-${{ matrix.python-version }}
        path: htmlcov/
        
  game-logic-tests:
    name: Game Logic Tests
    needs: unit-tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install pytest
        
    - name: Run critical game logic tests
      run: |
        echo "=== è¿è¡Œå…³é”®æ¸¸æˆé€»è¾‘æµ‹è¯• ==="
        
        # æµ‹è¯•äº¤æ˜“ç³»ç»Ÿ
        python -m pytest test_forest.py::TestForestGame::test_trade_success -v
        python -m pytest test_forest.py::TestForestGame::test_trade_fail_exceeds_limit -v
        
        # æµ‹è¯•æ•é£Ÿç³»ç»Ÿ
        python -m pytest test_forest.py::TestForestGame::test_hunt_success -v
        python -m pytest test_forest.py::TestForestGame::test_hunt_fail_reverse -v
        
        # æµ‹è¯•è§„åˆ™ç³»ç»Ÿ
        python -m pytest test_forest.py::TestForestGame::test_check_restraint_12_players -v
        python -m pytest test_rules.py::TestRestraintRules::test_rank_restraint_chain -v
        
        # æµ‹è¯•å…·ä½“æ¡ˆä¾‹ï¼šçº¢æ¡ƒKæ•é£Ÿé»‘æ¡ƒQ
        echo "=== æµ‹è¯•å…·ä½“æ¡ˆä¾‹ï¼šçº¢æ¡ƒKæ•é£Ÿé»‘æ¡ƒQ ==="
        python << 'END'
	import sys
	sys.path.append('.')
	try:
	    from forest import Game, Player, CardRank, CardSuit
	except ImportError:
	    import importlib.util
	    spec = importlib.util.spec_from_file_location('forest', 'forest.py')
	    forest = importlib.util.module_from_spec(spec)
	    spec.loader.exec_module(forest)
	    Game = forest.Game
	    Player = forest.Player
	    CardRank = forest.CardRank
	    CardSuit = forest.CardSuit
	
	# æµ‹è¯•çº¢æ¡ƒKæ•é£Ÿé»‘æ¡ƒQ
	game = Game()
	game.player_count = 12
	
	player1 = Player(1)  # çº¢æ¡ƒK
	player2 = Player(2)  # é»‘æ¡ƒQ
	
	player1.rank = CardRank.K
	player1.suit = CardSuit.HEART
	player2.rank = CardRank.Q
	player2.suit = CardSuit.SPADE
	
	result = game._check_restraint(player1, player2)
	print(f'å…‹åˆ¶å…³ç³»ç»“æœ: {result}')
	print(f'æœŸæœ›: 1 (çº¢æ¡ƒKåº”è¯¥å…‹åˆ¶é»‘æ¡ƒQ, å› ä¸ºK>Q)')
	assert result == 1, f'æµ‹è¯•å¤±è´¥: çº¢æ¡ƒKåº”è¯¥å…‹åˆ¶é»‘æ¡ƒQï¼Œä½†å¾—åˆ°{result}'
	print('âœ… æµ‹è¯•é€šè¿‡: çº¢æ¡ƒKå…‹åˆ¶é»‘æ¡ƒQ')
        END
        
  integration-tests:
    name: Integration Tests
    needs: game-logic-tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Run full game simulation
      run: |
        echo "=== è¿è¡Œå®Œæ•´æ¸¸æˆæ¨¡æ‹Ÿ ==="
        python -c "
import sys
sys.path.append('.')

# å¯¼å…¥æ¸¸æˆæ¨¡å—
try:
    from forest import Game
except ImportError:
    import importlib.util
    spec = importlib.util.spec_from_file_location('forest', 'forest.py')
    forest = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(forest)
    Game = forest.Game

# åˆ›å»ºæ¸¸æˆå®ä¾‹
game = Game()
game.player_count = 8
game.players = [Game.Player(i+1) for i in range(8)]
game._assign_identities()

print('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ')
print(f'ç©å®¶æ•°é‡: {len(game.players)}')
print(f'Jokeræ•°é‡: {sum(1 for p in game.players if p.rank == game.CardRank.JOKER)}')

# éªŒè¯æ‰€æœ‰ç©å®¶éƒ½æœ‰èº«ä»½
for player in game.players:
    assert player.rank is not None, f'ç©å®¶{player.no}æ²¡æœ‰ç‚¹æ•°èº«ä»½'
    assert player.suit is not None, f'ç©å®¶{player.no}æ²¡æœ‰èŠ±è‰²èº«ä»½'
    print(f'ç©å®¶{player.no}: {player.suit.value if player.suit.value != \"Joker\" else \"\"}{player.rank.value if player.rank.value != \"Joker\" else \"Joker\"}')

print('âœ… é›†æˆæµ‹è¯•é€šè¿‡')
        "
        
    - name: Verify export functionality
      run: |
        echo "=== æµ‹è¯•å¯¼å‡ºåŠŸèƒ½ ==="
        python -c "
import sys
sys.path.append('.')
import os
import tempfile

try:
    from forest import Game
except ImportError:
    import importlib.util
    spec = importlib.util.spec_from_file_location('forest', 'forest.py')
    forest = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(forest)
    Game = forest.Game

# åˆ›å»ºä¸´æ—¶ç›®å½•æµ‹è¯•å¯¼å‡º
with tempfile.TemporaryDirectory() as tmpdir:
    original_cwd = os.getcwd()
    os.chdir(tmpdir)
    
    try:
        game = Game()
        game.player_count = 6
        game.players = [Game.Player(i+1) for i in range(6)]
        game._assign_identities()
        
        # æ·»åŠ ä¸€äº›æ“ä½œè®°å½•
        game.records.append('æµ‹è¯•è®°å½•1')
        game.records.append('æµ‹è¯•è®°å½•2')
        
        # æµ‹è¯•å¯¼å‡º
        game.export_data()
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åˆ›å»º
        import glob
        txt_files = glob.glob('*.txt')
        assert len(txt_files) > 0, 'å¯¼å‡ºæ–‡ä»¶æœªåˆ›å»º'
        print(f'æ‰¾åˆ°å¯¼å‡ºæ–‡ä»¶: {txt_files[0]}')
        
        # æ£€æŸ¥æ–‡ä»¶å†…å®¹
        with open(txt_files[0], 'r', encoding='utf-8') as f:
            content = f.read()
            assert 'æ¸¸æˆæ•°æ®å¯¼å‡º' in content
            assert 'æµ‹è¯•è®°å½•1' in content
            print('âœ… å¯¼å‡ºåŠŸèƒ½æµ‹è¯•é€šè¿‡')
            
    finally:
        os.chdir(original_cwd)
        "
        
  security-check:
    name: Security Check
    needs: integration-tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check for secrets in code
      run: |
        echo "æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯..."
        # æ£€æŸ¥ç¡¬ç¼–ç çš„å¯†é’¥ã€å¯†ç ç­‰
        grep -r "password\|secret\|key\|token\|api_key" --include="*.py" . || echo "æœªå‘ç°æ˜æ˜¾æ•æ„Ÿä¿¡æ¯"
        
    - name: Check file permissions
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æƒé™..."
        find . -name "*.py" -type f ! -perm 644 -exec echo "è­¦å‘Š: æ–‡ä»¶æƒé™å¼‚å¸¸: {}" \;
        
  final-validation:
    name: Final Validation
    needs: [code-quality, unit-tests, game-logic-tests, integration-tests, security-check]
    runs-on: ubuntu-latest
    
    steps:
    - name: Check all jobs passed
      run: |
        echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡!"
        echo "ä»£ç è´¨é‡: âœ…"
        echo "å•å…ƒæµ‹è¯•: âœ…"
        echo "æ¸¸æˆé€»è¾‘: âœ…"
        echo "é›†æˆæµ‹è¯•: âœ…"
        echo "å®‰å…¨æ£€æŸ¥: âœ…"
        echo ""
        echo "å¯ä»¥å®‰å…¨åœ°åˆå¹¶ä»£ç "
